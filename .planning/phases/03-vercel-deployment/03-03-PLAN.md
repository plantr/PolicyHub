---
phase: 03-vercel-deployment
plan: 03
type: execute
wave: 2
depends_on: [03-01, 03-02]
files_modified: []
autonomous: false
requirements: [DEPL-01, DEPL-03, DEPL-05]

user_setup:
  - service: vercel
    why: "Vercel deployment requires authenticated CLI and project linking"
    env_vars:
      - name: VITE_SUPABASE_URL
        source: "Supabase Dashboard > Project Settings > API > Project URL"
      - name: VITE_SUPABASE_PUBLISHABLE_KEY
        source: "Supabase Dashboard > Project Settings > API > anon (public) key"
      - name: SUPABASE_SERVICE_ROLE_KEY
        source: "Supabase Dashboard > Project Settings > API > service_role key"
      - name: DATABASE_URL
        source: "Supabase Dashboard > Project Settings > Database > Connection string (Transaction mode, port 6543)"
      - name: AI_INTEGRATIONS_ANTHROPIC_API_KEY
        source: "https://console.anthropic.com/account/keys"
    dashboard_config:
      - task: "Set all 5 environment variables in Vercel project settings"
        location: "Vercel Dashboard > Project > Settings > Environment Variables"
      - task: "Apply ai_jobs migration to Supabase"
        location: "Supabase Dashboard > SQL Editor — run supabase/migrations/0006_ai_jobs.sql"

must_haves:
  truths:
    - "The React SPA loads at the Vercel production URL with all client-side routes working (no 404 on refresh)"
    - "API endpoints respond correctly via the Express serverless function (GET /api/business-units returns JSON)"
    - "Environment variables are accessible in the correct context (VITE_ vars client-side, secrets server-side only)"
    - "Preview deployments are created automatically for branches/PRs"
  artifacts: []
  key_links:
    - from: "Vercel CDN"
      to: "dist/public/index.html"
      via: "vercel.json outputDirectory"
      pattern: "outputDirectory"
    - from: "Vercel function"
      to: "server/index.ts default export"
      via: "Express framework detection"
      pattern: "export default app"
---

<objective>
Validate the Vercel build pipeline locally and deploy to Vercel with full end-to-end verification.

Purpose: Plans 03-01 and 03-02 made all the code changes needed for Vercel compatibility. This plan validates those changes work in practice: first by running `vercel build` locally to catch build failures and path alias issues, then by deploying and verifying the live app.

Output: Verified Vercel deployment with working SPA routing, API endpoints, and environment configuration
</objective>

<execution_context>
@/Users/robert.plant/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robert.plant/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-vercel-deployment/03-01-SUMMARY.md
@.planning/phases/03-vercel-deployment/03-02-SUMMARY.md
@vercel.json
@server/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run vercel build locally to validate build pipeline</name>
  <files></files>
  <action>
Run the Vercel build locally to validate the full build pipeline before deploying:

1. Install Vercel CLI globally if not present: `npm install -g vercel`

2. Run `npx vite build` from the project root to verify the Vite SPA build succeeds:
   - Should output to `dist/public/` (per vite.config.ts build.outDir)
   - Should NOT fail on Replit plugin imports (guarded behind REPL_ID)
   - Should produce index.html + JS/CSS bundles

3. Verify the build output:
   - `ls dist/public/index.html` exists
   - `ls dist/public/assets/` has JS and CSS files

4. Check for path alias issues by verifying the server can be loaded:
   - `node -e "import('./server/index.ts')"` — this won't fully work without tsx, but:
   - `npx tsc --noEmit` to verify TypeScript is clean
   - Check that `@shared/*` imports in server/routes.ts resolve correctly in the TypeScript compilation

5. If the build fails:
   - **Replit plugin import error:** Verify the REPL_ID guard in vite.config.ts is correct
   - **Path alias error:** The `@shared/*` alias in vite.config.ts resolves for client builds; server-side path aliases are handled by Vercel's Express framework compilation
   - **Missing module:** Check if any import was accidentally removed during server/index.ts refactoring

6. If the build succeeds, verify the Vite output doesn't include any server-side secrets by checking:
   - `grep -r "SUPABASE_SERVICE_ROLE_KEY" dist/public/` should return nothing
   - `grep -r "AI_INTEGRATIONS_ANTHROPIC" dist/public/` should return nothing
   - Only VITE_ prefixed env vars should appear in the bundle (they get inlined as placeholders at build time)
  </action>
  <verify>
- `dist/public/index.html` exists
- `dist/public/assets/` contains JS and CSS files
- No server secrets leaked into the client bundle
- TypeScript compilation passes
  </verify>
  <done>Vite SPA build completes successfully, output in dist/public/, no server secrets in client bundle, TypeScript compilation clean</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Deploy to Vercel and verify end-to-end</name>
  <files></files>
  <action>
Deploy the project to Vercel and have the user verify end-to-end functionality. Claude runs `vercel` CLI to deploy, then the user verifies in browser.

What was built in Plans 03-01 and 03-02:
- vercel.json with SPA rewrites and build settings
- server/index.ts refactored with default export and synchronous route registration
- vite.config.ts with Replit plugins guarded
- package.json with Node 22.x engine
- ai_jobs table schema and migration
- AI endpoints refactored to background job + polling pattern
- .env.example with all required variables documented

Steps:
1. Apply the ai_jobs migration: Run `supabase/migrations/0006_ai_jobs.sql` in Supabase SQL Editor
2. Deploy to Vercel: `vercel` (or `vercel --yes`) from project root
3. Set environment variables in Vercel Dashboard (all 5 from .env.example, all environments)
4. Redeploy after env vars: `vercel --prod`
5. User verifies: SPA loads, routing works on refresh, API returns JSON, preview deploys work
  </action>
  <verify>
1. Visit Vercel URL — React app loads (Dashboard page)
2. Navigate to sub-route (e.g., /documents), refresh — no 404
3. Check Network tab — API calls return JSON, not HTML
4. Create test branch to verify preview deployment auto-creates
5. Verify data loads (proves client + server env vars work)
  </verify>
  <done>Vercel deployment live with working SPA routing, API endpoints returning JSON, environment variables correctly configured, and preview deployments enabled</done>
</task>

</tasks>

<verification>
1. Vite build succeeds locally with output in dist/public/
2. Vercel deployment URL loads the React SPA
3. Client-side routing works on page refresh (no 404s)
4. API endpoints return JSON, not HTML
5. Preview deployments auto-create for branches
6. All environment variables accessible in correct contexts
</verification>

<success_criteria>
The Policy Hub React SPA and Express API are running on Vercel. The app loads, API calls succeed, routing works on refresh, and preview deployments are enabled. The deployment satisfies all Phase 3 success criteria from the roadmap.
</success_criteria>

<output>
After completion, create `.planning/phases/03-vercel-deployment/03-03-SUMMARY.md`
</output>
