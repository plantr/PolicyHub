---
phase: 03-vercel-deployment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - vercel.json
  - package.json
  - vite.config.ts
  - .env.example
  - server/index.ts
autonomous: true
requirements: [DEPL-01, DEPL-02, DEPL-04, DEPL-05, DEPL-06, FUNC-01, FUNC-04]

must_haves:
  truths:
    - "vercel.json exists with SPA rewrites that exclude /api/ paths and correct buildCommand/outputDirectory"
    - "server/index.ts exports the Express app as default and registers routes synchronously (no IIFE)"
    - "Vite build succeeds on non-Replit environments (Replit plugins guarded behind REPL_ID check)"
    - "package.json declares Node 22.x engine and Vercel-compatible build script"
    - ".env.example documents all 5 required environment variables with source locations"
  artifacts:
    - path: "vercel.json"
      provides: "Vercel project configuration with SPA rewrites and build settings"
      contains: "rewrites"
    - path: "server/index.ts"
      provides: "Vercel-compatible Express app with default export"
      exports: ["default"]
    - path: ".env.example"
      provides: "Environment variable documentation for all deployment contexts"
      contains: "VITE_SUPABASE_URL"
  key_links:
    - from: "vercel.json"
      to: "dist/public"
      via: "outputDirectory"
      pattern: "outputDirectory.*dist/public"
    - from: "server/index.ts"
      to: "server/routes.ts"
      via: "synchronous registerRoutes call"
      pattern: "registerRoutes\\(httpServer, app\\)"
---

<objective>
Configure the Vercel project files and adapt the Express server for Vercel's serverless function model.

Purpose: The existing Express server runs as a Replit monolith with an async IIFE initialization pattern that is incompatible with Vercel's function model. This plan creates the Vercel configuration (vercel.json, build settings, env documentation) and refactors server/index.ts to export the Express app as a default export with synchronous route registration — the two foundational changes required before any deployment can succeed.

Output: vercel.json, updated package.json, Vercel-safe vite.config.ts, updated server/index.ts with default export, comprehensive .env.example
</objective>

<execution_context>
@/Users/robert.plant/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robert.plant/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-vercel-deployment/03-RESEARCH.md
@server/index.ts
@server/routes.ts (first 50 lines — registerRoutes signature)
@vite.config.ts
@package.json
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create vercel.json, update package.json and vite.config.ts for Vercel compatibility</name>
  <files>vercel.json, package.json, vite.config.ts</files>
  <action>
1. Create `vercel.json` at project root with this exact configuration:
```json
{
  "$schema": "https://openapi.vercel.sh/vercel.json",
  "buildCommand": "npx vite build",
  "outputDirectory": "dist/public",
  "rewrites": [
    {
      "source": "/((?!api/).*)",
      "destination": "/index.html"
    }
  ]
}
```
Notes:
- `buildCommand: "npx vite build"` bypasses the Replit-specific `script/build.ts` (which includes esbuild server bundling not needed for Vercel)
- `outputDirectory: "dist/public"` matches vite.config.ts `build.outDir`
- The rewrite uses negative lookahead `(?!api/)` to exclude `/api/*` paths from the SPA catch-all — Vercel's Express framework integration handles those via the server function
- No `functions` block needed — Vercel auto-detects the Express server. If maxDuration tuning is needed later, it can be added
- DEPL-05 (preview deployments) is enabled by default when the Git repo is connected to Vercel — no config needed
- DEPL-06 is superseded by user decision: manual env var config in Vercel dashboard, NOT Supabase Marketplace integration

2. Update `package.json`:
- Add `"engines": { "node": "22.x" }` at the top level (after `"license"` field)
- Keep existing `"build": "tsx script/build.ts"` script — do NOT change it. Vercel uses `buildCommand` from vercel.json, not the package.json build script. The existing build script is still needed for Replit compatibility during the transition period.
- Do NOT add or change the `"main"` field

3. Update `vite.config.ts` to guard the Replit runtime error overlay plugin behind `REPL_ID`:
- Currently `runtimeErrorOverlay()` is imported and used unconditionally on line 4 and line 9
- The import `import runtimeErrorOverlay from "@replit/vite-plugin-runtime-error-modal"` must be made conditional
- Change the plugins array so ALL Replit plugins (including runtimeErrorOverlay) are only loaded when `process.env.REPL_ID` is defined
- Use dynamic import pattern for all Replit plugins to avoid import failures on Vercel:
```typescript
plugins: [
  react(),
  ...(process.env.REPL_ID
    ? [
        (await import("@replit/vite-plugin-runtime-error-modal")).default(),
        ...(process.env.NODE_ENV !== "production"
          ? [
              await import("@replit/vite-plugin-cartographer").then((m) => m.cartographer()),
              await import("@replit/vite-plugin-dev-banner").then((m) => m.devBanner()),
            ]
          : []),
      ]
    : []),
],
```
- Remove the static import of `runtimeErrorOverlay` at the top of the file
  </action>
  <verify>
- `cat vercel.json` shows valid JSON with rewrites, buildCommand, outputDirectory
- `node -e "const p = require('./package.json'); console.log(p.engines)"` prints `{ node: '22.x' }`
- `grep -c "runtimeErrorOverlay" vite.config.ts` returns 0 (no static import of the Replit plugin)
- `grep "REPL_ID" vite.config.ts` shows the guard condition
  </verify>
  <done>vercel.json exists with SPA rewrites excluding /api/ paths, package.json has engines.node "22.x", vite.config.ts guards all Replit plugins behind REPL_ID check</done>
</task>

<task type="auto">
  <name>Task 2: Refactor server/index.ts for Vercel-compatible Express export</name>
  <files>server/index.ts</files>
  <action>
Refactor `server/index.ts` to remove the async IIFE pattern and export the Express app as a default export. The current code wraps everything in `(async () => { ... })()` which means routes are registered asynchronously after the module exports. Vercel imports the default export and expects a ready-to-use Express app.

**Key insight from research:** `registerRoutes()` is declared `async` but the registration itself is synchronous — it just calls `app.get()`, `app.post()`, etc. The `async` keyword is vestigial. The function can be called synchronously and its return value ignored (it returns `Promise<Server>` but we don't need the resolved value since we already have `httpServer`).

Changes to make:

1. Remove the async IIFE wrapper `(async () => { ... })()`
2. Call `registerRoutes(httpServer, app)` synchronously at module top level (ignore the returned Promise — route registration is synchronous)
3. Register the error handler middleware after registerRoutes (same as now, just not inside IIFE)
4. Remove the Vite dev server setup and static serving — on Vercel, the SPA is served from CDN via `dist/public`. For local dev, use `vercel dev` or the existing `tsx server/index.ts` flow. Guard the Vite/static serving behind `!process.env.VERCEL`:
```typescript
if (!process.env.VERCEL) {
  if (process.env.NODE_ENV === "production") {
    serveStatic(app);
  } else {
    // Dynamic import for Vite dev server
    import("./vite").then(({ setupVite }) => setupVite(httpServer, app));
  }
}
```
5. Guard the `httpServer.listen()` call behind `!process.env.VERCEL` so it only listens locally:
```typescript
if (!process.env.VERCEL) {
  const port = parseInt(process.env.PORT || "5000", 10);
  httpServer.listen({ port, host: "0.0.0.0" }, () => {
    log(`serving on port ${port}`);
  });
}
```
6. Add `export default app;` as the final line of the file

The final structure should be:
```
imports
app + httpServer creation
rawBody middleware
urlencoded middleware
log function
logging middleware
registerRoutes(httpServer, app)  // synchronous, top-level
error handler middleware
if (!process.env.VERCEL) { Vite/static + listen }
export default app
```

**Do NOT:**
- Remove the `log()` function export (other files may import it)
- Change the rawBody capture middleware
- Modify any route registration logic
- Remove the `createServer(app)` pattern — `httpServer` is still needed for local dev and for any WebSocket setup
  </action>
  <verify>
- `grep "export default app" server/index.ts` returns the export line
- `grep -c "async ()" server/index.ts` returns 0 (no IIFE)
- `grep "VERCEL" server/index.ts` shows the environment guards
- `grep "registerRoutes" server/index.ts` shows a synchronous call (no `await` before it)
- The file still has `import { registerRoutes }`, `import { serveStatic }`, the `log` function export, and middleware setup
  </verify>
  <done>server/index.ts exports Express app as default, registers routes synchronously without IIFE, conditionally listens and serves static only when not on Vercel</done>
</task>

<task type="auto">
  <name>Task 3: Update .env.example with comprehensive Vercel deployment documentation</name>
  <files>.env.example</files>
  <action>
Replace the existing `.env.example` with a comprehensive version that documents all 5 required environment variables with source locations, context (client vs server), and Vercel environment assignment. Per user decision: this file must document where to find each value.

Content:
```bash
# =============================================
# SUPABASE — Client-side (safe to expose, inlined by Vite at build time)
# Vercel: Set in ALL environments (Production, Preview, Development)
# =============================================
# Found in: Supabase Dashboard > Project Settings > API > Project URL
VITE_SUPABASE_URL=https://xxxxxxxxxxxxx.supabase.co

# Found in: Supabase Dashboard > Project Settings > API > anon (public) key
# NOTE: Post-May 2025 Supabase projects use sb_publishable_xxx format
VITE_SUPABASE_PUBLISHABLE_KEY=eyJ...

# =============================================
# SUPABASE — Server-side only (NEVER prefix with VITE_)
# Vercel: Set in ALL environments (Production, Preview, Development)
# =============================================
# Found in: Supabase Dashboard > Project Settings > API > service_role key
# WARNING: This key bypasses Row Level Security. Keep secret.
SUPABASE_SERVICE_ROLE_KEY=eyJ...

# =============================================
# DATABASE — Supabase pooler (transaction mode, port 6543)
# Vercel: Set in ALL environments (Production, Preview, Development)
# =============================================
# Found in: Supabase Dashboard > Project Settings > Database > Connection string
# IMPORTANT: Use the "Transaction" pooler URL (port 6543, NOT 5432)
# The direct URL (port 5432) will exhaust connections in serverless
DATABASE_URL=postgresql://postgres.xxxxx:PASSWORD@aws-0-REGION.pooler.supabase.com:6543/postgres

# Direct connection — only for Drizzle migrations (not used at runtime)
DATABASE_URL_DIRECT=postgresql://postgres.xxxxx:PASSWORD@aws-0-REGION.supabase.com:5432/postgres

# =============================================
# AI — Anthropic Claude
# Vercel: Set in ALL environments (Production, Preview, Development)
# =============================================
# Found in: https://console.anthropic.com/account/keys
AI_INTEGRATIONS_ANTHROPIC_API_KEY=sk-ant-api03-...

# Optional: Anthropic base URL override (for proxies/testing)
# AI_INTEGRATIONS_ANTHROPIC_BASE_URL=
```

This satisfies:
- DEPL-03: All 5 env vars documented
- DEPL-04: Client-side vars use VITE_ prefix
- DEPL-06 (superseded): Manual config documented, no Supabase Marketplace reference
  </action>
  <verify>
- `grep "VITE_SUPABASE_URL" .env.example` shows the variable with Vercel assignment comment
- `grep "port 6543" .env.example` shows the pooler connection guidance
- `grep "AI_INTEGRATIONS_ANTHROPIC_API_KEY" .env.example` shows the Anthropic key
- The file has exactly 5 required env vars (VITE_SUPABASE_URL, VITE_SUPABASE_PUBLISHABLE_KEY, SUPABASE_SERVICE_ROLE_KEY, DATABASE_URL, AI_INTEGRATIONS_ANTHROPIC_API_KEY) plus optional DATABASE_URL_DIRECT and AI_INTEGRATIONS_ANTHROPIC_BASE_URL
  </verify>
  <done>.env.example comprehensively documents all environment variables with source locations, Vercel environment assignments, and security warnings</done>
</task>

</tasks>

<verification>
1. `vercel.json` exists and is valid JSON
2. `vite.config.ts` has no unconditional Replit imports
3. `server/index.ts` has `export default app` and no IIFE
4. `package.json` has `"engines": { "node": "22.x" }`
5. `.env.example` lists all 5 required variables with documentation
6. TypeScript type check passes: `npx tsc --noEmit` (may have pre-existing issues but should not introduce new ones)
</verification>

<success_criteria>
The project has a valid vercel.json, the Express server exports its app as a default export with synchronous route registration, Replit plugins are conditionally loaded, and all environment variables are documented — the project is structurally ready for `vercel build` and deployment.
</success_criteria>

<output>
After completion, create `.planning/phases/03-vercel-deployment/03-01-SUMMARY.md`
</output>
