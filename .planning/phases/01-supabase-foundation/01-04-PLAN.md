---
phase: 01-supabase-foundation
plan: 04
type: execute
wave: 3
depends_on:
  - 01-01
files_modified:
  - client/src/lib/supabase.ts
  - .env.example
autonomous: false
requirements:
  - AUTH-01
  - AUTH-02
  - AUTH-03
  - AUTH-04
  - AUTH-06
  - INFRA-05

user_setup:
  - service: supabase-auth
    why: "Auth configuration requires dashboard settings"
    env_vars:
      - name: VITE_SUPABASE_URL
        source: "Supabase Dashboard → Project Settings → API → Project URL"
      - name: VITE_SUPABASE_PUBLISHABLE_KEY
        source: "Supabase Dashboard → Project Settings → API → anon/public key (or publishable key for post-May 2025 projects)"
      - name: SUPABASE_SERVICE_ROLE_KEY
        source: "Supabase Dashboard → Project Settings → API → service_role key (NEVER expose to client)"
    dashboard_config:
      - task: "Disable email confirmation: Authentication → General → Confirm email → OFF"
        location: "Supabase Dashboard → Authentication → General"
      - task: "Disable new user signup: Authentication → General → Allow new users to sign up → OFF"
        location: "Supabase Dashboard → Authentication → General"
      - task: "Set JWT expiry to 604800 seconds (7 days): Authentication → Sessions → JWT Expiry"
        location: "Supabase Dashboard → Authentication → Sessions"
      - task: "Disable inactivity timeout: Authentication → Sessions → Inactivity Timeout → 0"
        location: "Supabase Dashboard → Authentication → Sessions"
      - task: "Set minimum password length to 8: Authentication → Passwords → Minimum password length → 8"
        location: "Supabase Dashboard → Authentication → Passwords"
      - task: "Enable Custom Access Token Hook: Authentication → Hooks → Custom Access Token → select public.custom_access_token_hook"
        location: "Supabase Dashboard → Authentication → Hooks"
  - service: smtp-provider
    why: "Auth emails (invite, password reset) require custom SMTP — Supabase default is 2/hour"
    env_vars: []
    dashboard_config:
      - task: "Configure custom SMTP in Supabase: Project Settings → Auth → SMTP → Enable Custom SMTP"
        location: "Supabase Dashboard → Project Settings → Auth → SMTP"
      - task: "Set SMTP Host (e.g., smtp.resend.com), Port 587, User (resend), Password (API key), Sender email/name"
        location: "Supabase Dashboard → Project Settings → Auth → SMTP"

must_haves:
  truths:
    - "The Supabase JS client is initialized with the project URL and publishable key"
    - "A user can be invited by email via the admin API and log in with a password"
    - "A user can reset their password via email link"
    - "Sessions persist across browser refresh via Supabase JS auto-refresh"
    - "Auth emails (invite, password reset) are delivered via custom SMTP"
    - "An admin can assign a user to a business unit with a role (admin/editor/viewer) by creating a user_business_units row"
  artifacts:
    - path: "client/src/lib/supabase.ts"
      provides: "Supabase client singleton for browser use"
      contains: "createClient"
    - path: ".env.example"
      provides: "Environment variable documentation for all Supabase vars"
      contains: "VITE_SUPABASE_URL"
  key_links:
    - from: "client/src/lib/supabase.ts"
      to: "Supabase project"
      via: "VITE_SUPABASE_URL + VITE_SUPABASE_PUBLISHABLE_KEY env vars"
      pattern: "import.meta.env.VITE_SUPABASE"
---

<objective>
Set up the Supabase client library, configure auth settings, and verify the invite + login + password reset flows work end-to-end.

Purpose: This plan delivers working authentication. A user can be invited by an admin, set their password, log in, and their session persists. Password reset via email works. The JWT contains per-BU role claims (from the hook in Plan 02). This is the last piece before the phase is functionally complete.

Output: Supabase client file, environment variable documentation, verified auth flows.
</objective>

<execution_context>
@/Users/robert.plant/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robert.plant/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-supabase-foundation/01-RESEARCH.md
@.planning/phases/01-supabase-foundation/01-01-SUMMARY.md
@.planning/phases/01-supabase-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Supabase client, create client module, and document environment variables</name>
  <files>client/src/lib/supabase.ts, .env.example, package.json</files>
  <action>
**1. Install @supabase/supabase-js:**

```bash
npm install @supabase/supabase-js
```

**2. Create the Supabase client singleton for browser use:**

Create `client/src/lib/supabase.ts`:

```typescript
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
const supabaseKey = import.meta.env.VITE_SUPABASE_PUBLISHABLE_KEY;

if (!supabaseUrl || !supabaseKey) {
  throw new Error(
    'Missing Supabase environment variables. Set VITE_SUPABASE_URL and VITE_SUPABASE_PUBLISHABLE_KEY in .env'
  );
}

export const supabase = createClient(supabaseUrl, supabaseKey, {
  auth: {
    // Auto-refresh is ON by default — sessions persist across page refresh
    // Storage defaults to localStorage — correct for SPA
    autoRefreshToken: true,
    persistSession: true,
  },
});
```

**3. Create a server-side admin client helper:**

Create `server/lib/supabase-admin.ts`:

```typescript
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = process.env.VITE_SUPABASE_URL || process.env.SUPABASE_URL;
const serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

if (!supabaseUrl || !serviceRoleKey) {
  throw new Error(
    'Missing Supabase admin environment variables. Set SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY'
  );
}

// Service role client — bypasses RLS. NEVER expose to the browser.
export const supabaseAdmin = createClient(supabaseUrl, serviceRoleKey, {
  auth: {
    autoRefreshToken: false,
    persistSession: false,
  },
});
```

**4. Create/update `.env.example` with all required variables:**

```bash
# Supabase
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_PUBLISHABLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# Supabase service role — NEVER expose to client
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# Database (Supabase)
DATABASE_URL=postgresql://postgres.[ref]:[password]@aws-0-[region].pooler.supabase.com:6543/postgres
DATABASE_URL_DIRECT=postgresql://postgres.[ref]:[password]@aws-0-[region].supabase.com:5432/postgres

# AI (existing)
AI_INTEGRATIONS_ANTHROPIC_API_KEY=sk-ant-...
```

Ensure `.env` is in `.gitignore` (it likely already is, but verify).

**5. Add `.env` to `.gitignore` if not already present:**

Check `.gitignore` for `.env` pattern. If missing, add it.
  </action>
  <verify>
1. `npm ls @supabase/supabase-js` — installed
2. `cat client/src/lib/supabase.ts | grep "createClient"` — client created
3. `cat server/lib/supabase-admin.ts | grep "SUPABASE_SERVICE_ROLE_KEY"` — admin client created
4. `cat .env.example | grep "VITE_SUPABASE_URL"` — env var documented
5. `grep ".env" .gitignore` — .env is gitignored
  </verify>
  <done>
@supabase/supabase-js is installed. Browser client at client/src/lib/supabase.ts and admin client at server/lib/supabase-admin.ts are created. Environment variables are documented in .env.example.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify Supabase project setup, auth configuration, and SMTP</name>
  <files>N/A — verification checkpoint</files>
  <action>
This is a human verification checkpoint. All prior plans (01-03) and Task 1 of this plan must be complete. The user needs to:

1. Provision a Supabase project and set environment variables
2. Apply all migrations (Drizzle schema + RLS + auth hook)
3. Configure auth settings in the Supabase Dashboard
4. Configure custom SMTP for auth emails
5. Enable the Custom Access Token Hook in the dashboard
6. Test the end-to-end auth flow (invite, login, password reset, JWT claims)

**Detailed verification steps:**

**Step 1: Verify Supabase project exists and env vars are set**
- Confirm you have a Supabase project at https://supabase.com/dashboard
- Copy the Project URL and anon/publishable key into `.env` as `VITE_SUPABASE_URL` and `VITE_SUPABASE_PUBLISHABLE_KEY`
- Copy the service_role key into `SUPABASE_SERVICE_ROLE_KEY`
- Copy database connection strings into `DATABASE_URL` (port 6543) and `DATABASE_URL_DIRECT` (port 5432)

**Step 2: Apply migrations** (if not already done)
```bash
npx drizzle-kit migrate
psql $DATABASE_URL_DIRECT -f supabase/migrations/0001_enable_rls.sql
psql $DATABASE_URL_DIRECT -f supabase/migrations/0002_auth_hook.sql
psql $DATABASE_URL_DIRECT -f supabase/migrations/0003_rls_policies.sql
```

**Step 3: Verify dashboard configuration**
- Authentication → General: "Confirm email" is OFF
- Authentication → General: "Allow new users to sign up" is OFF
- Authentication → Sessions: JWT Expiry is 604800
- Authentication → Sessions: Inactivity Timeout is 0
- Authentication → Passwords: Minimum password length is 8
- Authentication → Hooks: Custom Access Token hook → `public.custom_access_token_hook`
- Project Settings → Auth → SMTP: Custom SMTP enabled and configured

**Step 4: Verify RLS**
Run in Supabase SQL Editor:
```sql
SELECT tablename FROM pg_tables WHERE schemaname = 'public' AND rowsecurity = false;
```
Expected: zero rows.

**Step 5: Test auth flow**
Create a test BU in SQL Editor, then invite a test user via the admin client.
  </action>
  <verify>
User confirms: all dashboard settings correct, migrations applied, RLS query returns zero rows, test invite email received, test login works, JWT contains business_units claims.
  </verify>
  <done>
Supabase project is fully configured: schema migrated, RLS enabled with policies on all 33 tables, auth hook active, SMTP working, and a test user can be invited and log in with correct JWT claims.
  </done>
</task>

</tasks>

<verification>
1. Supabase client library exists at `client/src/lib/supabase.ts` and exports `supabase`
2. Admin client library exists at `server/lib/supabase-admin.ts` and exports `supabaseAdmin`
3. `.env.example` documents all required environment variables
4. Auth configuration verified in Supabase Dashboard (confirm email off, signup off, JWT 7 days, hook enabled)
5. Custom SMTP configured and delivering emails
6. RLS verification query returns zero rows
7. A test user can be invited and log in
</verification>

<success_criteria>
- @supabase/supabase-js is installed and the browser client is initialized
- The admin client (service role) is available for server-side operations
- All Supabase Auth settings match the specification (no confirm, no signup, 7-day JWT, hook enabled)
- Custom SMTP is configured and emails are delivered
- A user can be invited by email and can log in after setting their password
- Sessions persist across browser refresh
- The JWT contains business_units claims from the Custom Access Token Hook
</success_criteria>

<output>
After completion, create `.planning/phases/01-supabase-foundation/01-04-SUMMARY.md`
</output>
