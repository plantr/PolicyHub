---
phase: 04-client-migration-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - client/src/hooks/use-auth.ts
  - client/src/components/auth/AuthPage.tsx
  - client/src/components/auth/ProtectedRoute.tsx
  - client/src/components/user-menu.tsx
  - client/src/App.tsx
  - client/src/lib/queryClient.ts
  - package.json
autonomous: true
requirements: [CLNT-01, CLNT-04, CLNT-05]

must_haves:
  truths:
    - "User sees a branded login page at /login with Policy Hub logo and auth form"
    - "User can sign up, sign in, and reset password via the auth form"
    - "After login, user is redirected to the dashboard"
    - "Unauthenticated user attempting any app route is redirected to /login"
    - "Session expiry shows a toast 'Session expired, please log in again' then redirects to /login"
    - "User can log out via avatar dropdown in the header"
    - "All React Query cache is cleared on sign-out"
  artifacts:
    - path: "client/src/hooks/use-auth.ts"
      provides: "Auth state hook with session, user, loading, and session expiry signal"
      contains: "onAuthStateChange"
    - path: "client/src/components/auth/AuthPage.tsx"
      provides: "Branded login/signup/reset page using @supabase/auth-ui-react"
      contains: "Auth"
    - path: "client/src/components/auth/ProtectedRoute.tsx"
      provides: "Route guard redirecting unauthenticated users to /login"
      contains: "Redirect"
    - path: "client/src/components/user-menu.tsx"
      provides: "User avatar dropdown with logout in the header"
      contains: "signOut"
  key_links:
    - from: "client/src/hooks/use-auth.ts"
      to: "supabase.auth.onAuthStateChange"
      via: "Auth state subscription"
      pattern: "onAuthStateChange"
    - from: "client/src/components/auth/ProtectedRoute.tsx"
      to: "client/src/hooks/use-auth.ts"
      via: "useAuth hook checks session"
      pattern: "useAuth"
    - from: "client/src/App.tsx"
      to: "client/src/components/auth/ProtectedRoute.tsx"
      via: "Wraps protected routes"
      pattern: "ProtectedRoute"
    - from: "client/src/hooks/use-auth.ts"
      to: "queryClient.clear()"
      via: "Cache clear on SIGNED_OUT"
      pattern: "queryClient\\.clear"
---

<objective>
Build the Supabase Auth UI (login, signup, password reset), auth state management hook, route protection, and user menu with logout. This is the auth foundation that all subsequent plans depend on.

Purpose: Users need to authenticate before accessing the app. The auth layer protects all routes, manages session state, and clears cached data on sign-out.
Output: Working auth flow — login page, protected routes, session management, user dropdown with logout.
</objective>

<execution_context>
@/Users/robert.plant/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robert.plant/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-client-migration-cleanup/04-RESEARCH.md
@client/src/App.tsx
@client/src/lib/supabase.ts
@client/src/lib/queryClient.ts
@client/src/components/app-sidebar.tsx
@client/src/hooks/use-toast.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install auth-ui packages, create useAuth hook and AuthPage component</name>
  <files>
    package.json
    client/src/hooks/use-auth.ts
    client/src/components/auth/AuthPage.tsx
    client/src/components/auth/ProtectedRoute.tsx
  </files>
  <action>
    1. Install packages: `npm install @supabase/auth-ui-react @supabase/auth-ui-shared`

    2. Create `client/src/hooks/use-auth.ts`:
       - Export `useAuth()` hook returning `{ session, user, loading, sessionExpired }`
       - On mount, call `supabase.auth.getSession()` to load initial session, set loading=false
       - Subscribe via `supabase.auth.onAuthStateChange(event, session)`:
         - Always: `setSession(session)`
         - On `SIGNED_OUT` when previously authenticated: set `sessionExpired=true`, then `setTimeout(() => queryClient.clear(), 0)` — NO await inside callback (deadlock risk)
       - Return cleanup: `subscription.unsubscribe()`
       - Import `queryClient` from `@/lib/queryClient` (already exported)

    3. Create `client/src/components/auth/AuthPage.tsx`:
       - Import `Auth` from `@supabase/auth-ui-react` and `ThemeSupa` from `@supabase/auth-ui-shared` (NOT from auth-ui-react)
       - Import `supabase` from `@/lib/supabase`
       - Import `useAuth` hook — if already authenticated (`session` exists), redirect to `/` using wouter `Redirect`
       - Render a centered card layout with Policy Hub branding:
         - Outer: `min-h-screen flex flex-col items-center justify-center bg-background`
         - Logo area: Use a Shield icon from lucide-react (the app's identity) with "Policy Hub" text, styled to match the sidebar header
         - Card: `w-full max-w-sm rounded-lg border bg-card p-8 shadow-sm`
       - Auth component config:
         - `supabaseClient={supabase}`
         - `appearance.theme = ThemeSupa`
         - `appearance.variables.default.colors`: brand = `hsl(var(--primary))`, brandAccent = `hsl(var(--primary))`, brandButtonText = `hsl(var(--primary-foreground))`, inputBackground = `hsl(var(--background))`, inputBorder = `hsl(var(--border))`, inputText = `hsl(var(--foreground))`
         - `appearance.variables.default.radii`: borderRadiusButton = `0.375rem`
         - `providers={[]}` (no OAuth)
         - `showLinks={true}` (shows "Sign up" and "Forgot password?" links for view switching)

    4. Create `client/src/components/auth/ProtectedRoute.tsx`:
       - Import `useAuth` from `@/hooks/use-auth`
       - Import `Redirect` from `wouter` and `useLocation` from `wouter`
       - Import `useToast` from `@/hooks/use-toast`
       - Props: `{ children: React.ReactNode }`
       - If `loading`, render a centered spinner (use lucide-react Loader2 with `animate-spin`)
       - If `!session`, render `<Redirect to="/login" />`
       - If `sessionExpired`, show toast "Session expired, please log in again" via `useEffect` watching `sessionExpired`, then redirect to `/login`
       - Otherwise render `{children}`

    5. Verify CLNT-01: Read `client/src/lib/supabase.ts` — confirm singleton with anon key, `autoRefreshToken: true`, `persistSession: true`. No changes needed per research (already correct).
  </action>
  <verify>
    - `npm ls @supabase/auth-ui-react @supabase/auth-ui-shared` shows both installed
    - Files exist: `client/src/hooks/use-auth.ts`, `client/src/components/auth/AuthPage.tsx`, `client/src/components/auth/ProtectedRoute.tsx`
    - `npx tsc --noEmit` passes (type check)
  </verify>
  <done>
    useAuth hook manages session state and clears cache on SIGNED_OUT. AuthPage renders branded Supabase Auth form. ProtectedRoute redirects unauthenticated users. Session expiry triggers toast + redirect.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire auth into App.tsx — route protection, user menu, and login route</name>
  <files>
    client/src/components/user-menu.tsx
    client/src/App.tsx
    client/src/lib/queryClient.ts
  </files>
  <action>
    1. Create `client/src/components/user-menu.tsx`:
       - Import `useAuth` from `@/hooks/use-auth`
       - Import `supabase` from `@/lib/supabase`
       - Import DropdownMenu components from `@/components/ui/dropdown-menu` (already in codebase)
       - Import Avatar components from `@/components/ui/avatar` (already in codebase)
       - Import `LogOut`, `User` icons from `lucide-react`
       - Display user avatar (initials from `user.email`) as trigger
       - Dropdown content:
         - User email (label, non-interactive)
         - Separator
         - "Log out" item with LogOut icon — calls `supabase.auth.signOut()` on click
       - Export as named `UserMenu`

    2. Update `client/src/App.tsx`:
       - Add imports: `AuthPage` from `@/components/auth/AuthPage`, `ProtectedRoute` from `@/components/auth/ProtectedRoute`, `UserMenu` from `@/components/user-menu`
       - Restructure the App component:
         - Move the existing `Router()` function and sidebar+header layout into a new inner component or keep inline
         - In the top-level return, wrap with `QueryClientProvider` and `TooltipProvider` and `ThemeProvider` as before
         - Add a top-level `Switch`:
           - `<Route path="/login" component={AuthPage} />` — public, outside protected wrapper
           - Default route: wrap everything else (sidebar, header, Router) in `<ProtectedRoute>`
         - In the header, replace the existing bare `<ThemeToggle />` area to include `<UserMenu />` next to `<ThemeToggle />`

    3. Update `client/src/lib/queryClient.ts`:
       - Update the default `on401` behavior from `"throw"` to `"returnNull"` — with auth in place, 401s should gracefully return null (the ProtectedRoute handles redirect), not throw errors that create noisy UI error states
       - Keep `apiRequest()`, `throwIfResNotOk()`, and `getQueryFn()` as-is — they are still used for mutations to serverless functions

    4. Ensure the `refetchOnWindowFocus: false` setting remains (locked decision: data refreshes on navigation only, no background polling or window-focus refetching).
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npx vite build` succeeds (client builds without errors)
    - Grep App.tsx for `ProtectedRoute` and `AuthPage` — both present
    - Grep App.tsx for `UserMenu` — present in header
  </verify>
  <done>
    App.tsx has /login as a public route, all other routes wrapped in ProtectedRoute. Header shows user avatar dropdown with logout. React Query 401 handling returns null (graceful for auth redirects).
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — full type check passes
2. `npx vite build` — client build succeeds
3. Grep for `onAuthStateChange` in use-auth.ts — present with `setTimeout` pattern (no deadlock)
4. Grep for `ThemeSupa` import — from `@supabase/auth-ui-shared` (NOT auth-ui-react)
5. Grep for `queryClient.clear()` in use-auth.ts — called on SIGNED_OUT via setTimeout
6. Grep App.tsx for `/login` route, `ProtectedRoute`, `UserMenu`
7. Grep for `supabase.auth.signOut()` in user-menu.tsx
</verification>

<success_criteria>
- Auth UI page renders at /login with branded Policy Hub card and Supabase Auth form
- Unauthenticated users redirected to /login from any route
- Authenticated users see sidebar + header with user avatar dropdown + logout
- Sign-out clears React Query cache and redirects to /login
- Session expiry shows toast notification then redirects
- Build passes (tsc + vite build)
</success_criteria>

<output>
After completion, create `.planning/phases/04-client-migration-cleanup/04-01-SUMMARY.md`
</output>
