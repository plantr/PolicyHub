---
phase: 04-client-migration-cleanup
plan: 04
type: execute
wave: 3
depends_on: ["04-02", "04-03"]
files_modified:
  - package.json
  - vite.config.ts
  - .gitignore
  - client/src/pages/Documents.tsx
  - README.md
autonomous: true
requirements: [CLNP-01, CLNP-02, CLNP-03, CLNP-05, CLNP-06]

must_haves:
  truths:
    - "No references to .replit, server/replit_integrations/, @replit/* packages in tracked files"
    - "No references to passport, passport-local, express-session, connect-pg-simple, memorystore in package.json"
    - "No references to @aws-sdk/*, multer, @types/multer in package.json"
    - "server/s3.ts, server/vite.ts, server/static.ts, script/build.ts deleted"
    - "server/replit_integrations/ directory deleted"
    - ".replit file removed from tracking (added to .gitignore)"
    - "No hardcoded port 5000 or REPL_ID env detection in application code"
    - "npm run dev starts via vercel dev"
    - "Document upload flow uses TUS signed-URL pattern instead of multer FormData"
    - "CLNP-06 already satisfied (engines.node = 22.x)"
    - "README updated with Supabase + Vercel setup instructions"
  artifacts:
    - path: "package.json"
      provides: "Clean dependencies — no passport, multer, S3, Replit packages"
      contains: "vercel dev"
    - path: "vite.config.ts"
      provides: "Clean Vite config — no Replit plugin conditionals"
      contains: "react"
    - path: ".gitignore"
      provides: "Replit files ignored"
      contains: ".replit"
    - path: "README.md"
      provides: "Updated setup instructions for Supabase + Vercel"
      contains: "vercel dev"
  key_links:
    - from: "package.json"
      to: "vercel dev"
      via: "dev script"
      pattern: "vercel dev"
    - from: "client/src/pages/Documents.tsx"
      to: "client/src/lib/storage.ts"
      via: "TUS upload replaces multer FormData"
      pattern: "uploadFileToStorage"
---

<objective>
Remove all legacy code: Replit config/integrations, Passport.js/express-session, AWS S3/multer, Express dev server helpers, hardcoded ports. Migrate document upload UI to TUS flow. Update package.json scripts and README for Vercel dev workflow.

Purpose: Clean the codebase of all migration-era dead code. After this, the project is a clean Supabase + Vercel application with no Replit or legacy dependencies.
Output: Clean codebase — no legacy packages, no dead files, no Replit references. README documents the new architecture.
</objective>

<execution_context>
@/Users/robert.plant/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robert.plant/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-client-migration-cleanup/04-RESEARCH.md
@.planning/phases/04-client-migration-cleanup/04-02-SUMMARY.md
@.planning/phases/04-client-migration-cleanup/04-03-SUMMARY.md
@package.json
@vite.config.ts
@server/s3.ts
@server/vite.ts
@server/static.ts
@script/build.ts
@client/src/pages/Documents.tsx
@client/src/lib/storage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove legacy packages, files, and Replit code</name>
  <files>
    package.json
    vite.config.ts
    .gitignore
  </files>
  <action>
    1. **Uninstall legacy packages:**
       ```bash
       npm uninstall passport passport-local express-session connect-pg-simple memorystore
       npm uninstall @aws-sdk/client-s3 @aws-sdk/s3-request-presigner multer @types/multer
       npm uninstall @replit/vite-plugin-cartographer @replit/vite-plugin-dev-banner @replit/vite-plugin-runtime-error-modal
       npm uninstall @types/connect-pg-simple @types/express-session @types/passport @types/passport-local
       ```

    2. **Delete legacy files:**
       - `server/s3.ts` — S3 stub (deprecated per research)
       - `server/vite.ts` — Vite dev server middleware (only used by Express dev server)
       - `server/static.ts` — Static file serving (only used by Express production mode)
       - `script/build.ts` — Replit-era esbuild bundler (replaced by scripts/build-api.mjs + vite build)
       - `server/replit_integrations/` — entire directory (batch/ and chat/)

    3. **Delete .replit from git tracking** (but keep in .gitignore):
       - `git rm --cached .replit 2>/dev/null` (if tracked)
       - Add to `.gitignore`: `.replit`, `replit.nix`

    4. **Clean `vite.config.ts`:**
       - Remove the entire `process.env.REPL_ID` conditional block (lines 8-22)
       - The config should be:
         ```typescript
         import { defineConfig } from "vite";
         import react from "@vitejs/plugin-react";
         import path from "path";

         export default defineConfig({
           plugins: [react()],
           resolve: {
             alias: {
               "@": path.resolve(import.meta.dirname, "client", "src"),
               "@shared": path.resolve(import.meta.dirname, "shared"),
               "@assets": path.resolve(import.meta.dirname, "attached_assets"),
             },
           },
           root: path.resolve(import.meta.dirname, "client"),
           build: {
             outDir: path.resolve(import.meta.dirname, "dist/public"),
             emptyOutDir: true,
           },
         });
         ```
       - Remove the `server.fs` block (was for Replit security — not needed for local/Vercel)

    5. **Update `package.json` scripts:**
       - Change `"dev"` from `"NODE_ENV=development tsx server/index.ts"` to `"vercel dev"` (locked decision)
       - Change `"build"` from `"tsx script/build.ts"` to `"npx vite build && node scripts/build-api.mjs"` (matches vercel.json buildCommand)
       - Remove `"start": "NODE_ENV=production node dist/index.cjs"` — Vercel handles production; no standalone start needed
       - Keep `"check": "tsc"` and `"db:push": "drizzle-kit push"`

    6. **Remove port 5000 references:** Already removed by deleting `server/index.ts` local listener block — but verify no other files reference port 5000 or `REPL_ID`. Grep the codebase.

    7. **CLNP-06 verification:** Confirm `"engines": { "node": "22.x" }` exists in package.json — per research, already present. No action needed.

    8. **Remove `script/` directory** if `build.ts` was the only file in it (check first).

    9. **Clean `server/index.ts`:** This file is still needed as the base Express app for serverless functions (they import `storage` from `server/storage.ts`). However, remove the `!process.env.VERCEL` block at the bottom (lines 81-102) — the static/vite/listen code is dead. Keep the Express app setup, middleware, route registration, and error handler. Also remove the imports of `./vite` and `./static` since those files are deleted. The file becomes a pure Express app factory with no HTTP listener — only used by serverless functions that import from `server/storage.ts`.

       Actually, re-examine: Do the serverless functions in api/*.ts import from server/index.ts? No — they import from `server/storage.ts` directly. The `server/index.ts` was the Express app used by `api/_entry.ts` which is now deleted. So `server/index.ts` can potentially be deleted too, OR kept as a minimal module if anything imports the `log()` function or `app` object.

       Check if any api/*.ts files or other server files import from `server/index.ts`. If nothing imports it, delete it. If `server/routes.ts` is no longer needed (all routes are in individual api/*.ts files), delete it too.

       **Decision tree:**
       - If `server/routes.ts` still imported by anything: keep but plan to remove later
       - If no imports: delete `server/routes.ts` and `server/index.ts`
       - Keep `server/storage.ts`, `server/db.ts`, `server/lib/supabase-admin.ts`, `server/storage-supabase.ts` — these are the data access layer used by serverless functions
  </action>
  <verify>
    - `npm ls passport` — not found (uninstalled)
    - `npm ls multer` — not found
    - `npm ls @aws-sdk/client-s3` — not found
    - `npm ls @replit/vite-plugin-cartographer` — not found
    - Files deleted: `server/s3.ts`, `server/vite.ts`, `server/static.ts`, `script/build.ts`, `server/replit_integrations/` directory
    - Grep for `REPL_ID` in `vite.config.ts` — not found
    - Grep for `port.*5000` across all source files — not found
    - `npx tsc --noEmit` passes (no broken imports from deleted files)
    - `.gitignore` contains `.replit`
  </verify>
  <done>
    All legacy packages uninstalled. Dead files deleted. Replit conditionals removed from vite.config.ts. Package.json scripts updated to vercel dev workflow. No port 5000 or REPL_ID references remain.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate document upload UI to TUS flow and update README</name>
  <files>
    client/src/pages/Documents.tsx
    README.md
  </files>
  <action>
    1. **Migrate document upload in Documents.tsx:**
       - Find the document creation mutation that currently posts FormData to `/api/documents` (Research says line ~398)
       - Replace with the TUS signed-URL flow:
         a. Create the document record via `apiRequest("POST", "/api/documents", { title, ... })` (metadata only, no file)
         b. If a file is selected, call `uploadFileToStorage()` from `client/src/lib/storage.ts` (already created in Phase 2) with the document version ID
         c. `uploadFileToStorage()` handles: get signed upload URL -> TUS upload -> confirm upload
       - Remove any `new FormData()` usage and multer-dependent multipart upload
       - The document creation serverless function (`api/documents.ts`) no longer needs multer — it receives JSON body with metadata, not multipart/form-data
       - Ensure progress feedback works (uploadFileToStorage has a progress callback)
       - Also check `DocumentDetail.tsx` for any version upload flows and migrate those similarly

    2. **Create/Update README.md:**
       - Title: "Policy Hub"
       - Brief description: Policy and compliance management platform
       - Tech stack: React + TypeScript, Supabase (database, auth, storage), Vercel (hosting, serverless functions), Drizzle ORM, React Query, Tailwind CSS
       - Prerequisites: Node.js 22.x, Vercel CLI (`npm i -g vercel`), Supabase project
       - Setup instructions:
         a. Clone repo
         b. `npm install`
         c. Copy `.env.example` to `.env` and fill in:
            - `VITE_SUPABASE_URL` — Supabase project URL
            - `VITE_SUPABASE_PUBLISHABLE_KEY` — Supabase anon/publishable key
            - `SUPABASE_SERVICE_ROLE_KEY` — Supabase service role key (server-side only)
            - `DATABASE_URL` — Supabase pooled connection string
            - `ANTHROPIC_API_KEY` — For AI analysis features
         d. Run Drizzle migrations: `npm run db:push`
         e. Start dev server: `npm run dev` (runs `vercel dev`)
       - Project structure overview (client/, server/, api/, shared/)
       - Deployment: Push to main branch for automatic Vercel deployment (or `vercel --prod` manually)
       - Architecture notes: Direct Supabase reads from frontend (RLS enforced), serverless functions for writes and AI operations

    3. **Final verification sweep:**
       - Grep entire codebase for `passport`, `express-session`, `multer`, `replit_integrations`, `.replit`, `s3.ts`, `server/vite`, `server/static` — zero matches in source code (may appear in git history, that's fine)
       - Confirm no broken imports: `npx tsc --noEmit`
       - Confirm build works: `npx vite build && node scripts/build-api.mjs`
  </action>
  <verify>
    - Grep `Documents.tsx` for `FormData` — not found (replaced with JSON + TUS)
    - Grep `Documents.tsx` for `uploadFileToStorage` — present
    - `README.md` exists with `vercel dev` in setup instructions
    - `npx tsc --noEmit` passes
    - `npx vite build && node scripts/build-api.mjs` succeeds
    - Grep across codebase for legacy references: `passport`, `multer`, `REPL_ID`, `server/s3`, `server/vite.ts`, `server/static.ts` — zero matches in .ts/.tsx/.json files
  </verify>
  <done>
    Document upload uses TUS flow (no multer). README documents Supabase + Vercel architecture. Codebase has zero legacy references. Full build passes.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — type check passes
2. `npx vite build && node scripts/build-api.mjs` — full build pipeline succeeds
3. Grep for legacy patterns across all source files:
   - `passport` — 0 matches
   - `express-session` — 0 matches
   - `multer` — 0 matches (in source; may remain in lock file)
   - `@aws-sdk` — 0 matches
   - `REPL_ID` — 0 matches
   - `replit_integrations` — 0 matches
   - `port.*5000` — 0 matches
   - `server/s3` — 0 matches
   - `server/vite` — 0 matches
   - `server/static` — 0 matches
4. `package.json` scripts.dev = `"vercel dev"`
5. `package.json` engines.node = `"22.x"` (CLNP-06)
6. `.gitignore` contains `.replit`
7. README.md exists with setup instructions
</verification>

<success_criteria>
- Zero references to Replit, Passport, S3, multer in source code
- Legacy files (s3.ts, vite.ts, static.ts, build.ts, replit_integrations/) deleted
- vite.config.ts has no REPL_ID conditionals
- package.json has clean dependencies and vercel dev script
- Document upload uses TUS signed-URL flow
- README documents Supabase + Vercel setup
- Full build passes (tsc + vite + api build)
</success_criteria>

<output>
After completion, create `.planning/phases/04-client-migration-cleanup/04-04-SUMMARY.md`
</output>
